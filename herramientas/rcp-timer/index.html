<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timer RCP - Bomberos Toolkit</title>
    <style>
        :root {
            --primary-red: #e74c3c;
            --primary-dark-red: #c0392b;
            --success-green: #27ae60;
            --warning-orange: #f39c12;
            --dark-gray: #2c3e50;
            --light-gray: #ecf0f1;
            --white: #ffffff;
            --shadow-md: 0 5px 20px rgba(0, 0, 0, 0.15);
            --border-radius-md: 15px;
            --spacing-md: 20px;
            --spacing-lg: 30px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: var(--dark-gray);
            user-select: none;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-red) 0%, var(--primary-dark-red) 100%);
            color: var(--white);
            padding: var(--spacing-md);
            text-align: center;
            box-shadow: var(--shadow-md);
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .breadcrumb {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px var(--spacing-md);
            font-size: 0.9em;
        }

        .breadcrumb a {
            color: var(--white);
            text-decoration: none;
            opacity: 0.8;
        }

        .breadcrumb a:hover {
            opacity: 1;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: var(--spacing-lg);
        }

        .timer-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            box-shadow: var(--shadow-md);
            text-align: center;
            margin-bottom: var(--spacing-lg);
        }

        .timer-display {
            font-size: 4em;
            font-weight: bold;
            color: var(--primary-red);
            font-family: 'Courier New', monospace;
            margin: var(--spacing-md) 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            min-height: 1.2em;
        }

        .cycle-counter {
            font-size: 1.5em;
            color: var(--dark-gray);
            margin-bottom: var(--spacing-md);
        }

        .compression-counter {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-red);
            margin: 10px 0;
            min-height: 1.2em;
        }

        .compression-visual {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 5px;
            margin: 15px 0;
        }

        .compression-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ddd;
            border: 2px solid #ccc;
            transition: all 0.3s ease;
        }

        .compression-dot.completed {
            background: var(--success-green);
            border-color: var(--success-green);
        }

        .compression-dot.current {
            background: var(--primary-red);
            border-color: var(--primary-red);
            transform: scale(1.3);
            box-shadow: 0 0 10px rgba(231, 76, 60, 0.6);
        }

        .compression-dot.warning {
            background: var(--warning-orange);
            border-color: var(--warning-orange);
        }

        .phase-display {
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 25px;
            margin-bottom: var(--spacing-md);
            transition: all 0.3s ease;
        }

        .phase-compressions {
            background: var(--primary-red);
            color: var(--white);
        }

        .phase-ventilations {
            background: var(--success-green);
            color: var(--white);
        }

        .phase-paused {
            background: var(--warning-orange);
            color: var(--white);
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: var(--spacing-md);
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary {
            background: var(--primary-red);
            color: var(--white);
        }

        .btn-primary:hover {
            background: var(--primary-dark-red);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success-green);
            color: var(--white);
        }

        .btn-success:hover {
            background: #219a52;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning-orange);
            color: var(--white);
        }

        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light-gray);
            color: var(--dark-gray);
        }

        .btn-secondary:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .settings {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-lg);
        }

        .settings h3 {
            color: var(--dark-gray);
            margin-bottom: 15px;
            text-align: center;
        }

        .setting-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .setting-item {
            text-align: center;
        }

        .setting-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark-gray);
        }

        .setting-input {
            width: 80px;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            font-size: 1em;
        }

        .setting-input:focus {
            outline: none;
            border-color: var(--primary-red);
        }

        .sound-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }

        .stats {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-md);
        }

        .stats h3 {
            color: var(--dark-gray);
            margin-bottom: 15px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .stat-item {
            padding: 15px;
            background: var(--light-gray);
            border-radius: 8px;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-red);
            display: block;
        }

        .stat-label {
            color: var(--dark-gray);
            font-size: 0.9em;
            margin-top: 5px;
        }

        .visual-feedback {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            transition: background-color 0.1s ease;
        }

        .visual-feedback.flash-red {
            background-color: rgba(231, 76, 60, 0.3);
        }

        .visual-feedback.flash-green {
            background-color: rgba(39, 174, 96, 0.3);
        }

        .instructions {
            background: rgba(255, 255, 255, 0.95);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            box-shadow: var(--shadow-md);
            margin-bottom: var(--spacing-lg);
        }

        .instructions h3 {
            color: var(--dark-gray);
            margin-bottom: 10px;
            text-align: center;
        }

        .instructions ul {
            list-style-type: none;
            padding: 0;
        }

        .instructions li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }

        .instructions li:last-child {
            border-bottom: none;
        }

        .instructions .step-number {
            background: var(--primary-red);
            color: var(--white);
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8em;
            margin-right: 10px;
            flex-shrink: 0;
        }

        @media (max-width: 768px) {
            .timer-display {
                font-size: 3em;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 200px;
            }

            .setting-group {
                grid-template-columns: 1fr;
            }

            .sound-controls {
                flex-direction: column;
                align-items: center;
            }

            .container {
                padding: 15px;
            }
        }

        .pulsating {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .hidden {
            display: none;
        }

        .metronome-indicator {
            background: var(--primary-red);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin: 10px 0;
            font-weight: bold;
        }

        .metronome-indicator.active {
            animation: metronome-pulse 0.6s ease-in-out;
        }

        @keyframes metronome-pulse {
            0% { transform: scale(1); background: var(--primary-red); }
            50% { transform: scale(1.1); background: var(--warning-orange); }
            100% { transform: scale(1); background: var(--primary-red); }
        }
    </style>
</head>
<body>
    <div class="visual-feedback" id="visualFeedback"></div>

    <header class="header">
        <div class="breadcrumb">
            <a href="../../index.html">‚Üê Inicio</a> > <a href="../">Herramientas</a> > Timer RCP
        </div>
        <h1>‚è±Ô∏è Timer RCP</h1>
        <p>Cron√≥metro para Reanimaci√≥n Cardiopulmonar</p>
    </header>

    <div class="container">
        <!-- Instructions -->
        <div class="instructions">
            <h3>üìã Protocolo RCP</h3>
            <ul>
                <li>
                    <span class="step-number">1</span>
                    <span>30 compresiones tor√°cicas (ritmo 100-120/min)</span>
                </li>
                <li>
                    <span class="step-number">2</span>
                    <span>2 ventilaciones de rescate (1 segundo cada una)</span>
                </li>
                <li>
                    <span class="step-number">3</span>
                    <span>Repetir ciclos sin interrupci√≥n</span>
                </li>
                <li>
                    <span class="step-number">4</span>
                    <span>Evaluar pulso cada 2 minutos (5 ciclos)</span>
                </li>
            </ul>
        </div>

        <!-- Timer Display -->
        <div class="timer-container">
            <div class="cycle-counter">
                Ciclo: <span id="cycleCount">0</span> / 5
            </div>
            <div class="phase-display" id="phaseDisplay">Presiona INICIAR para comenzar</div>
            
            <!-- Contador de compresiones y visual -->
            <div id="compressionSection" class="hidden">
                <div class="compression-counter" id="compressionCounter">0 / 30</div>
                <div class="compression-visual" id="compressionVisual"></div>
                <div class="metronome-indicator" id="metronomeIndicator">üéµ Sigue el ritmo del DEA</div>
            </div>
            
            <div class="timer-display" id="timerDisplay">00:00</div>
            
            <div class="controls">
                <button class="btn btn-success" id="startBtn" onclick="startTimer()">Iniciar</button>
                <button class="btn btn-warning" id="pauseBtn" onclick="pauseTimer()" disabled>Pausar</button>
                <button class="btn btn-secondary" id="resetBtn" onclick="resetTimer()">Reiniciar</button>
                <button class="btn btn-primary" id="nextPhaseBtn" onclick="nextPhase()" disabled>Siguiente Fase</button>
            </div>
        </div>

        <!-- Settings -->
        <div class="settings">
            <h3>‚öôÔ∏è Configuraci√≥n</h3>
            <div class="setting-group">
                <div class="setting-item">
                    <label class="setting-label">Compresiones</label>
                    <input type="number" class="setting-input" id="compressionsCount" value="30" min="15" max="50">
                </div>
                <div class="setting-item">
                    <label class="setting-label">Ventilaciones</label>
                    <input type="number" class="setting-input" id="ventilationsCount" value="2" min="1" max="5">
                </div>
                <div class="setting-item">
                    <label class="setting-label">Tiempo Compresi√≥n (seg)</label>
                    <input type="number" class="setting-input" id="compressionTime" value="18" min="10" max="30" step="0.5">
                </div>
                <div class="setting-item">
                    <label class="setting-label">Tiempo Ventilaci√≥n (seg)</label>
                    <input type="number" class="setting-input" id="ventilationTime" value="4" min="2" max="10">
                </div>
            </div>
            
            <div class="sound-controls">
                <div class="checkbox-group">
                    <input type="checkbox" id="soundEnabled" checked>
                    <label for="soundEnabled">üîä Audio DEA</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="vibrationEnabled" checked>
                    <label for="vibrationEnabled">üì≥ Vibraci√≥n</label>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="visualEnabled" checked>
                    <label for="visualEnabled">üí° Feedback Visual</label>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div class="stats">
            <h3>üìä Estad√≠sticas</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number" id="totalCycles">0</span>
                    <span class="stat-label">Ciclos Completados</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalTime">00:00</span>
                    <span class="stat-label">Tiempo Total</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalCompressions">0</span>
                    <span class="stat-label">Compresiones</span>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalVentilations">0</span>
                    <span class="stat-label">Ventilaciones</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado del timer
        let isRunning = false;
        let isPaused = false;
        let currentPhase = 'stopped'; // 'stopped', 'compressions', 'ventilations'
        let phaseTimer = 0;
        let totalTimer = 0;
        let currentCycle = 0;
        let interval = null;
        
        // Estado de las compresiones
        let currentCompression = 0;
        let compressionInterval = null;
        
        // Estad√≠sticas
        let stats = {
            totalCycles: 0,
            totalTime: 0,
            totalCompressions: 0,
            totalVentilations: 0
        };

        // Elementos DOM
        const timerDisplay = document.getElementById('timerDisplay');
        const phaseDisplay = document.getElementById('phaseDisplay');
        const cycleCount = document.getElementById('cycleCount');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const nextPhaseBtn = document.getElementById('nextPhaseBtn');
        const visualFeedback = document.getElementById('visualFeedback');
        const compressionSection = document.getElementById('compressionSection');
        const compressionCounter = document.getElementById('compressionCounter');
        const compressionVisual = document.getElementById('compressionVisual');
        const metronomeIndicator = document.getElementById('metronomeIndicator');

        // Configuraci√≥n
        function getSettings() {
            return {
                compressions: parseInt(document.getElementById('compressionsCount').value),
                ventilations: parseInt(document.getElementById('ventilationsCount').value),
                compressionTime: parseFloat(document.getElementById('compressionTime').value),
                ventilationTime: parseFloat(document.getElementById('ventilationTime').value),
                soundEnabled: document.getElementById('soundEnabled').checked,
                vibrationEnabled: document.getElementById('vibrationEnabled').checked,
                visualEnabled: document.getElementById('visualEnabled').checked
            };
        }

        // Audio Context para sonidos
        let audioContext = null;
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Sonido de compresi√≥n como DEA
        function playCompressionSound(isWarning = false) {
            const settings = getSettings();
            if (!settings.soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Frecuencias: normal 600Hz, advertencia (√∫ltimas 3) 800Hz
            oscillator.frequency.setValueAtTime(
                isWarning ? 800 : 600, 
                audioContext.currentTime
            );
            
            oscillator.type = 'sine';
            
            // Volumen y duraci√≥n
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.15);
        }

        function playTone(frequency, duration, volume = 0.1) {
            const settings = getSettings();
            if (!settings.soundEnabled || !audioContext) return;
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration / 1000);
        }

        function vibrate(pattern) {
            const settings = getSettings();
            if (settings.vibrationEnabled && navigator.vibrate) {
                navigator.vibrate(pattern);
            }
        }

        function showVisualFeedback(type) {
            const settings = getSettings();
            if (!settings.visualEnabled) return;
            
            visualFeedback.className = `visual-feedback flash-${type}`;
            setTimeout(() => {
                visualFeedback.className = 'visual-feedback';
            }, 200);
        }

        // Crear puntos visuales para compresiones
        function createCompressionVisual() {
            const settings = getSettings();
            compressionVisual.innerHTML = '';
            
            for (let i = 1; i <= settings.compressions; i++) {
                const dot = document.createElement('div');
                dot.className = 'compression-dot';
                dot.id = `compression-dot-${i}`;
                compressionVisual.appendChild(dot);
            }
        }

        // Actualizar visual de compresiones
        function updateCompressionVisual() {
            const settings = getSettings();
            
            for (let i = 1; i <= settings.compressions; i++) {
                const dot = document.getElementById(`compression-dot-${i}`);
                if (!dot) continue;
                
                dot.className = 'compression-dot';
                
                if (i < currentCompression) {
                    dot.classList.add('completed');
                } else if (i === currentCompression) {
                    dot.classList.add('current');
                    // √öltimas 3 compresiones en advertencia
                    if (i >= settings.compressions - 2) {
                        dot.classList.add('warning');
                    }
                }
            }
        }

        // Iniciar secuencia de compresiones
        function startCompressions() {
            const settings = getSettings();
            currentCompression = 0;
            createCompressionVisual();
            compressionSection.classList.remove('hidden');
            
            // Ritmo: 100-110 BPM = cada 545-600ms
            compressionInterval = setInterval(() => {
                if (currentCompression < settings.compressions && currentPhase === 'compressions') {
                    currentCompression++;
                    
                    // Determinar si es una compresi√≥n de advertencia (√∫ltimas 3)
                    const isWarning = currentCompression >= (settings.compressions - 2);
                    
                    // Reproducir sonido de compresi√≥n
                    playCompressionSound(isWarning);
                    
                    // Feedback visual y t√°ctil
                    showVisualFeedback('red');
                    vibrate([50]);
                    
                    // Animaci√≥n del indicador de metr√≥nomo
                    metronomeIndicator.classList.add('active');
                    setTimeout(() => {
                        metronomeIndicator.classList.remove('active');
                    }, 200);
                    
                    // Actualizar displays
                    compressionCounter.textContent = `${currentCompression} / ${settings.compressions}`;
                    updateCompressionVisual();
                    
                    // Finalizar compresiones
                    if (currentCompression >= settings.compressions) {
                        clearInterval(compressionInterval);
                        compressionInterval = null;
                        
                        // Sonido especial al completar compresiones
                        setTimeout(() => {
                            playTone(1000, 300, 0.2);
                        }, 300);
                    }
                }
            }, 545); // ~110 BPM
        }

        // Detener compresiones
        function stopCompressions() {
            if (compressionInterval) {
                clearInterval(compressionInterval);
                compressionInterval = null;
            }
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateDisplay() {
            timerDisplay.textContent = formatTime(phaseTimer);
            cycleCount.textContent = currentCycle;
            
            // Actualizar estad√≠sticas
            document.getElementById('totalCycles').textContent = stats.totalCycles;
            document.getElementById('totalTime').textContent = formatTime(stats.totalTime);
            document.getElementById('totalCompressions').textContent = stats.totalCompressions;
            document.getElementById('totalVentilations').textContent = stats.totalVentilations;
        }

        function startTimer() {
            if (!isRunning) {
                initAudio();
                isRunning = true;
                isPaused = false;
                currentPhase = 'compressions';
                phaseTimer = getSettings().compressionTime;
                
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                nextPhaseBtn.disabled = false;
                
                phaseDisplay.textContent = `üí™ COMPRESIONES (${getSettings().compressions})`;
                phaseDisplay.className = 'phase-display phase-compressions pulsating';
                
                // Iniciar secuencia de compresiones
                startCompressions();
                
                showVisualFeedback('red');
                playTone(800, 200);
                vibrate([100]);
                
                interval = setInterval(tick, 1000);
            }
        }

        function pauseTimer() {
            if (isRunning && !isPaused) {
                isPaused = true;
                clearInterval(interval);
                stopCompressions();
                
                phaseDisplay.textContent = '‚è∏Ô∏è PAUSADO';
                phaseDisplay.className = 'phase-display phase-paused';
                compressionSection.classList.add('hidden');
                
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                
                playTone(600, 300);
            }
        }

        function resetTimer() {
            isRunning = false;
            isPaused = false;
            currentPhase = 'stopped';
            phaseTimer = 0;
            totalTimer = 0;
            currentCycle = 0;
            currentCompression = 0;
            
            clearInterval(interval);
            stopCompressions();
            
            startBtn.disabled = false;
            pauseBtn.disabled = true;
            nextPhaseBtn.disabled = true;
            
            phaseDisplay.textContent = 'Presiona INICIAR para comenzar';
            phaseDisplay.className = 'phase-display';
            timerDisplay.textContent = '00:00';
            compressionSection.classList.add('hidden');
            
            updateDisplay();
            playTone(400, 200);
        }

        function nextPhase() {
            if (!isRunning || isPaused) return;
            
            const settings = getSettings();
            
            if (currentPhase === 'compressions') {
                // Cambiar a ventilaciones
                stopCompressions();
                currentPhase = 'ventilations';
                phaseTimer = settings.ventilationTime;
                stats.totalCompressions += settings.compressions;
                
                phaseDisplay.textContent = `ü´Å VENTILACIONES (${settings.ventilations})`;
                phaseDisplay.className = 'phase-display phase-ventilations pulsating';
                compressionSection.classList.add('hidden');
                
                showVisualFeedback('green');
                playTone(1000, 200);
                vibrate([50, 50, 50]);
                
            } else if (currentPhase === 'ventilations') {
                // Completar ciclo y volver a compresiones
                currentCycle++;
                stats.totalCycles++;
                stats.totalVentilations += settings.ventilations;
                
                if (currentCycle >= 5) {
                    // Pausa para evaluaci√≥n despu√©s de 5 ciclos (2 minutos aprox)
                    pauseTimer();
                    phaseDisplay.textContent = 'ü©∫ EVALUAR PULSO - Presiona INICIAR para continuar';
                    phaseDisplay.className = 'phase-display phase-paused';
                    
                    playTone(1200, 500);
                    vibrate([200, 100, 200, 100, 200]);
                    currentCycle = 0;
                } else {
                    // Continuar con compresiones
                    currentPhase = 'compressions';
                    phaseTimer = settings.compressionTime;
                    
                    phaseDisplay.textContent = `üí™ COMPRESIONES (${settings.compressions})`;
                    phaseDisplay.className = 'phase-display phase-compressions pulsating';
                    
                    // Reiniciar compresiones
                    startCompressions();
                    
                    showVisualFeedback('red');
                    playTone(800, 200);
                    vibrate([100]);
                }
            }
            
            updateDisplay();
        }

        function tick() {
            if (isPaused) return;
            
            phaseTimer--;
            totalTimer++;
            stats.totalTime++;
            
            // Alertas de tiempo SOLO durante ventilaciones
            if (currentPhase === 'ventilations') {
                if (phaseTimer <= 3 && phaseTimer > 0) {
                    playTone(600, 100);
                    vibrate([50]);
                } else if (phaseTimer === 0) {
                    // Tiempo agotado, cambiar fase autom√°ticamente
                    nextPhase();
                    return;
                }
            } else if (phaseTimer === 0) {
                // Solo cambiar fase autom√°ticamente si no es ventilaciones
                nextPhase();
                return;
            }
            
            updateDisplay();
        }

        // Atajos de teclado
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case ' ': // Espacio
                    e.preventDefault();
                    if (!isRunning) {
                        startTimer();
                    } else if (!isPaused) {
                        pauseTimer();
                    } else {
                        startTimer();
                    }
                    break;
                case 'r':
                case 'R':
                    resetTimer();
                    break;
                case 'n':
                case 'N':
                    nextPhase();
                    break;
                case 'Escape':
                    pauseTimer();
                    break;
            }
        });

        // Reanudar compresiones cuando se reanuda desde pausa
        function resumeCompressions() {
            if (currentPhase === 'compressions' && !compressionInterval) {
                // Calcular cu√°ntas compresiones faltan
                const settings = getSettings();
                const remainingTime = phaseTimer;
                const totalCompressionTime = settings.compressionTime;
                const progress = (totalCompressionTime - remainingTime) / totalCompressionTime;
                currentCompression = Math.floor(progress * settings.compressions);
                
                createCompressionVisual();
                updateCompressionVisual();
                compressionSection.classList.remove('hidden');
                
                // Continuar desde donde se qued√≥
                compressionInterval = setInterval(() => {
                    if (currentCompression < settings.compressions && currentPhase === 'compressions') {
                        currentCompression++;
                        
                        const isWarning = currentCompression >= (settings.compressions - 2);
                        playCompressionSound(isWarning);
                        
                        showVisualFeedback('red');
                        vibrate([50]);
                        
                        metronomeIndicator.classList.add('active');
                        setTimeout(() => {
                            metronomeIndicator.classList.remove('active');
                        }, 200);
                        
                        compressionCounter.textContent = `${currentCompression} / ${settings.compressions}`;
                        updateCompressionVisual();
                        
                        if (currentCompression >= settings.compressions) {
                            clearInterval(compressionInterval);
                            compressionInterval = null;
                            setTimeout(() => {
                                playTone(1000, 300, 0.2);
                            }, 300);
                        }
                    }
                }, 545);
            }
        }

        // Modificar startTimer para manejar reanudaci√≥n
        function startTimerModified() {
            if (!isRunning) {
                // Inicio nuevo
                initAudio();
                isRunning = true;
                isPaused = false;
                currentPhase = 'compressions';
                phaseTimer = getSettings().compressionTime;
                
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                nextPhaseBtn.disabled = false;
                
                phaseDisplay.textContent = `üí™ COMPRESIONES (${getSettings().compressions})`;
                phaseDisplay.className = 'phase-display phase-compressions pulsating';
                
                startCompressions();
                
                showVisualFeedback('red');
                playTone(800, 200);
                vibrate([100]);
                
                interval = setInterval(tick, 1000);
            } else if (isPaused) {
                // Reanudar
                isPaused = false;
                
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                
                if (currentPhase === 'compressions') {
                    phaseDisplay.textContent = `üí™ COMPRESIONES (${getSettings().compressions})`;
                    phaseDisplay.className = 'phase-display phase-compressions pulsating';
                    resumeCompressions();
                } else if (currentPhase === 'ventilations') {
                    phaseDisplay.textContent = `ü´Å VENTILACIONES (${getSettings().ventilations})`;
                    phaseDisplay.className = 'phase-display phase-ventilations pulsating';
                }
                
                interval = setInterval(tick, 1000);
                playTone(800, 200);
            }
        }

        // Reemplazar la funci√≥n startTimer original
        function startTimer() {
            startTimerModified();
        }

        // Prevenir zoom en dispositivos m√≥viles
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        // Inicializaci√≥n
        updateDisplay();
        
        // Mantener pantalla encendida si es posible
        if ('wakeLock' in navigator) {
            let wakeLock = null;
            
            async function requestWakeLock() {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                } catch (err) {
                    console.log('Wake Lock no disponible:', err.message);
                }
            }
            
            // Activar wake lock al iniciar
            startBtn.addEventListener('click', requestWakeLock);
        }

        // Crear visual inicial
        createCompressionVisual();
        compressionSection.classList.add('hidden');
    </script>
</body>
</html>